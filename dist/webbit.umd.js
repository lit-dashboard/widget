var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,r)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__spreadValues=(e,t)=>{for(var r in t||(t={}))__hasOwnProp.call(t,r)&&__defNormalProp(e,r,t[r]);if(__getOwnPropSymbols)for(var r of __getOwnPropSymbols(t))__propIsEnum.call(t,r)&&__defNormalProp(e,r,t[r]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t));!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@webbitjs/store")):"function"==typeof define&&define.amd?define(["@webbitjs/store"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).webbit=t(e.webbitStore)}(this,(function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=t(e);const s=new RegExp("^[a-z]+(([0-9])|([A-Z0-9][a-z0-9]+))*([A-Z])?$"),n=new RegExp("^([a-z][a-z0-9]*)(-[a-z0-9]+)*$"),o=new RegExp("^(String|Boolean|Number|Array|Object)$"),i=e=>e instanceof Object&&null!==e&&"Source"===e.constructor.__WEBBIT_CLASSNAME__,u=(e,t)=>{if(e===t)return!0;if(typeof e!=typeof t)return!1;if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}return!1},c=e=>!1===e?e:((e,t)=>{if("string"!=typeof e||!n.test(e))throw new Error(`The ${t} must be a string written in kebab case.`);return e})(e,"property's attribute"),a=e=>((e,t)=>{if("string"!=typeof e||!s.test(e))throw new Error(`The ${t} must be a string written in camel case.`);return e})(e,"property's name"),p=e=>"string"==typeof e?e:"",l=e=>((e,t)=>{if("string"!=typeof name||!o.test(e))throw new Error((e=>`The ${e} must be a string with value 'String', 'Number', 'Boolean', 'Array' or 'Object'.`)(t));return e})(e,"property's type"),h=(e,t)=>{const r=void 0===t?(e=>({String:"",Number:0,Boolean:!1,Array:[],Object:{}}[e]))(e):t;if(!((e,t)=>{switch(e){case"String":return"string"==typeof t;case"Number":return"number"==typeof t;case"Boolean":return"boolean"==typeof t;case"Array":return t instanceof Array;case"Object":return t instanceof Object}return!1})(e,r))throw new Error("The property's default value does not match its type.");return r},d=(e,t)=>{if(!1===e)return e;if("string"!=typeof e)throw new Error(t);return e},f=e=>d(e,"changeEvent must be false or a string"),b=({description:e="",defaultSourceKey:t=!1,defaultSourceProvider:r=!1,properties:s={},events:n=[],slots:o=[],cssProperties:i=[],cssParts:u=[]}={})=>{return{description:p(e),defaultSourceKey:(y=t,d(y,"defaultSourceKey must be false or a string")),defaultSourceProvider:(b=r,d(b,"defaultSourceProvider must be false or a string")),properties:Object.fromEntries(Object.entries(s).map((([e,t])=>((e,{description:t="",type:r="String",defaultValue:s,attribute:n=!1,reflect:o=!1,primary:i=!1,changeEvent:u=!1}={})=>{const d=l(r),b=h(d,s);return[a(e),{description:p(t),type:d,defaultValue:b,attribute:c(n),reflect:!!o,primary:!!i,changeEvent:f(u)}]})(e,t)))),events:n,slots:o,cssProperties:i,cssParts:u};var b,y};class y{static prop2PropValue(e){if(null===e)return null;if(e instanceof Array)return e;if("string"==typeof e)try{const t=JSON.parse(e);return t instanceof Array?t:[]}catch(t){return[]}return[]}static prop2AttrValue(e){const t=y.prop2PropValue(e);return null===t?null:JSON.stringify(t)}static attr2PropValue(e){if(null===e)return null;try{const t=JSON.parse(e);return t instanceof Array?t:[]}catch(t){return[]}}}class _{static prop2PropValue(e){if(null===e)return null;if(e instanceof Object)return e;if("string"==typeof e)try{const t=JSON.parse(e);return t instanceof Object?t:{}}catch(t){return{}}return{}}static prop2AttrValue(e){const t=_.prop2PropValue(e);return null===t?null:JSON.stringify(t)}static attr2PropValue(e){if(null===e)return null;try{const t=JSON.parse(e);return t instanceof Object?t:{}}catch(t){return{}}}}const m={Array:y,Boolean:class{static prop2PropValue(e){return null===e?null:!!e}static prop2AttrValue(e){return e?"":null}static attr2PropValue(e){return null!==e}},Number:class{static prop2PropValue(e){return null===e?null:parseFloat(e)}static prop2AttrValue(e){return null===e?null:parseFloat(e)}static attr2PropValue(e,t){return null===e?null:parseFloat(e)}},Object:_,String:class{static prop2PropValue(e){return null===e?null:(null==e?void 0:e.toString())||""}static prop2AttrValue(e){return null===e?null:(null==e?void 0:e.toString())||""}static attr2PropValue(e,t){return null===e?null:e}}},g=(e,t)=>m[t].prop2PropValue(e),v=(e,t)=>m[t].attr2PropValue(e);class P{get value(){const{reflect:e,attribute:t,name:r,type:s}=this._property;return t&&e?v(this._element.getAttribute(t),s):r in this._element?this._element[r]:v(this._element.getAttribute(t),s)}set value(e){const{attribute:t,name:r,type:s}=this._property,n=(e=>"string"==typeof e?"String":"number"==typeof e?"Number":"boolean"==typeof e?"Boolean":e instanceof Array?"Array":e instanceof Object?"Object":null)(e),o=this.value;if(!u(g(o,n),e))if(t){const r=((e,t)=>m[t].prop2AttrValue(e))(e,s),o=v(r,n);u(e,o)&&(null===r?this._element.removeAttribute(t):this._element.setAttribute(t,r))}else{const t=g(e,s),o=g(t,n);u(e,o)&&(this._element[r]=t)}}constructor(e,t){this._element=e,this._property=t,this._connected=!1,this._defaultValue=this._property.defaultValue,this._subscribers=[],this._propertyObserver=this._getPropertyObserver()}_getPropertyObserver(){const{changeEvent:e,attribute:t}=this._property;if(e){const t=()=>{this._notifySubscribers()};return{connect:()=>{this._element.addEventListener(e,t,!1)},disconnect:()=>{this._element.removeEventListener(e,t,!1)}}}if(t){const e=new MutationObserver((()=>{this._notifySubscribers()}));return{connect:()=>{e.observe(this._element,{attributes:!0,attributeFilter:[t]})},disconnect:()=>{e.disconnect()}}}return{connect(){},disconnect(){}}}connect(){if(!this._connected){const e=this.value;this._defaultValue=void 0!==e?e:this._property.defaultValue,this._propertyObserver.connect(),this._connected=!0}}disconnect(){this._connected&&(this._connected=!1,this._propertyObserver.disconnect(),this._setToDefault())}update(e){this.connect(),this.value=e}subscribe(e){this._subscribers.push(e)}_notifySubscribers(){const e=this.value;this._subscribers.forEach((t=>{t(e)}))}_setToDefault(){this.value=this._defaultValue}}class S{get sourceProvider(){return this.element.getAttribute("source-provider")}get sourceKey(){return this.element.getAttribute("source-key")}set sourceProvider(e){e&&this.element.setAttribute("source-provider",e)}set sourceKey(e){e&&this.element.setAttribute("source-key",e)}get source(){return this.store.getSource(this.sourceProvider,this.sourceKey)}get hasSource(){return void 0!==this.store.getRawSource(this.sourceProvider,this.sourceKey)}constructor(e,t,r){this.element=e,this.store=t,this.config=b(r||{name:e.tagName.toLowerCase()});const s=Object.entries(this.config.properties).map((([e,t])=>__spreadProps(__spreadValues({},t),{name:e})));this.propertyHandlers=new Map(s.map((e=>{const t=new P(this.element,e);return t.subscribe((t=>{this._onPropertyUpdate(e,t)})),[e.name,t]}))),this.primaryPropertyConfig=s.find((({primary:e})=>e)),this.primaryPropertyHandler=this.primaryPropertyConfig?this.propertyHandlers.get(this.primaryPropertyConfig.name):null,this._connected=!1,this._sourceChangeObserver=this._getSourceChangeObserver(),this.defaultPropertyValues={},this._unsubscribe=()=>{},this.store.defaultSourceProviderSet((e=>{null===this.sourceProvider&&(this.sourceProvider=e)})),this.connect()}_getSourceChangeObserver(){const e=new MutationObserver((()=>{this._updateSubscription()}));return{connect:()=>{e.observe(this.element,{attributes:!0,attributeFilter:["source-provider","source-key"]})},disconnect:()=>{e.disconnect()}}}connect(){this._connected=!0,this._sourceChangeObserver.connect(),this._updateSubscription()}disconnect(){this._connected=!1,this._sourceChangeObserver.disconnect(),this._updateSubscription()}_updateSubscription(){if(!this._connected)return this._unsubscribe(),this._unsubscribe=()=>{},void this.propertyHandlers.forEach((e=>e.disconnect()));this.sourceKey||(this.sourceKey=this.config.defaultSourceKey),this.sourceProvider||(this.sourceProvider=this.config.defaultSourceProvider||this.store.getDefaultSourceProvider()),this.sourceKey&&this.sourceProvider?(this._unsubscribe(),this.propertyHandlers.forEach((e=>{e.disconnect()})),this._unsubscribe=this.store.subscribe(this.sourceProvider,this.sourceKey,((e,t,r)=>{this._subscriber(e,t,r)}),!0)):(this._unsubscribe(),this._unsubscribe=()=>{},this.propertyHandlers.forEach((e=>e.disconnect())))}_subscriber(e,t,r){if(void 0===e)this.propertyHandlers.forEach((e=>{e.disconnect()}));else if(i(e))if(t===r)Object.getOwnPropertyNames(e).forEach((t=>{this.propertyHandlers.has(t)&&this.propertyHandlers.get(t).update(e[t])}));else{const s=r.replace(t+"/","");if(this.propertyHandlers.has(s)){const t=this.propertyHandlers.get(s),r=e[s];void 0===r?t.disconnect():t.update(r)}}else this.primaryPropertyHandler&&this.primaryPropertyHandler.update(e)}_onPropertyUpdate({name:e,primary:t},r){const s=this.source;if(i(s))u(s[e],r)||(s[e]=r);else if(t&&!u(s,r)){this.store.getSourceProvider(this.sourceProvider).userUpdate(this.sourceKey,r)}}}class O extends e.SourceProvider{static get typeName(){return"Gamepad"}static get settingsDefaults(){return{}}constructor(e,t,r){super(e,t,r);const s=()=>{[...window.navigator.getGamepads()].forEach(((e,t)=>{if(!e)return this.removeSource(`${t}/axes`),this.removeSource(`${t}/connected`),this.removeSource(`${t}/id`),this.removeSource(`${t}/index`),this.removeSource(`${t}/mapping`),this.removeSource(`${t}/timestamp`),this.removeSource(`${t}/buttonPresses`),this.removeSource(`${t}/buttonTouches`),void this.removeSource(`${t}/buttonValues`);const{axes:r,buttons:s,connected:n,id:o,mapping:i,timestamp:u}=e;this.updateSource(`${t}/axes`,r),this.updateSource(`${t}/connected`,n),this.updateSource(`${t}/id`,o),this.updateSource(`${t}/index`,t),this.updateSource(`${t}/mapping`,i),this.updateSource(`${t}/timestamp`,u);const c=[],a=[],p=[];s.forEach(((e,t)=>{const{pressed:r,touched:s,value:n}=e;c.push(r),a.push(s),p.push(n)})),this.updateSource(`${t}/buttonPresses`,c),this.updateSource(`${t}/buttonTouches`,a),this.updateSource(`${t}/buttonValues`,p)})),window.requestAnimationFrame(s)};window.requestAnimationFrame(s)}}const w=new r.default;return w.addSourceProviderType(O),w.addSourceProvider("Gamepad","Gamepad"),document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector("#element");new S(e,w,{properties:{connected:{type:"Boolean",attribute:"connected"},buttonValues:{type:"Array",attribute:"button-values"}}})})),S}));
